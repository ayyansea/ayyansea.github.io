# AppDynamics

## Data Collector 

Дата коллектор - инструмент, который предоставляет контекст бизнес транзакций для последующего анализа и поиска проблем. 

Дата коллекторы делятся на два типа:
* коллекторы параметров методов, которые собирают аргументы, переменные и возвращаемые значения
* HTTP-коллекторы, которые собирают URL, значения параметров, заголовки и куки

Дата коллекторы собирают значения в виде строк, в отличие от Information Points, предоставляющих численные данные, которые можно преобразовать в метрики.

## Information Points

ИП - инструмент для превращения значений, возвращаемых или содержащихся в методах, в метрические данные. 

Отличие ИП от дата коллекторов в том, что вторые предоставляют контекст и данные в пределах бизнес-транзакции, а ИП позволяют следить за вызовом методов вне рамок транзакций. 

Получаемые данные можно преобразовывать, например вычислять сумму или среднее значение.

При создании ИП, появляются основные метрики, такие как:

* общее число вызовов
* вызовы в минуту
* ошибки в минуту
* среднее время отклика

Настраиваемые бизнес метрики же, поверх основных, могут отвечать на важные вопросы:

* какова средняя сумма на кредитной карте?
* сколько кредитных карт обработало приложение за определенный период, вне зависимости от бизнес-транзакций?
* сколько в среднем тратится времени на обработку карточки?
* и так далее.

## Snapshot

Когда составляются снапшоты?

* транзакция прошла медленно либо с ошибкой
* агент делает снапшоты с определенной периодичностью (10 минут по-умолчанию)
* агент делает снапшоты в пределах диагностической сессии

Снапшоты - средство выявления и устранения проблем с производительностью как конкретных транзакций, так и приложения в целом.

Любой Tier составляет снапшот, если транзакция идет медленно или очень медленно.

Начальный Tier составляет снапшот, когда:

* агент включает диагностическую сессию при обнаружении схожестей между возникающими проблемами
* агент видит медленное, очень медленное или застрявшее время отклика (или ошибки); у таких снапшотов может быть частичный список вызовов потому что они появляются в тот момент, когда транзакция замедлилась или выдала ошибку
* снапшот составляется по правилу периодичности (10 минут)

Последующие Тиры составляют снапшоты, когда:

* вышестоящий тир в непосредственной близости к последующему просит его сделать снапшот; просьба приходит когда:

* * вышестоящий тир составляет снапшоты во время диагностической сессии

* * вышестоящий тип составляет периодические снапшоты

У сбора снапшотов есть ограничения (на каждом отдельном node):

* начальные снапшоты транзакций могут собираться не чаще 20 раз в минуту с последующим сбором не более 5 снапшотов в минуту
* последующие снапшоты ограничены 100-200 экземплярами в минуту

Для транзакций с ошибками применяются следующие правила:

* 2 снапшота в минуту
* для всех транзакций на node ограничение стоит на 5 снапшотов в минуту (можно поменять количество с помощью переменной max-error-snapshots-per-minute)

## Baseline

Для чего нужны Baselines:
* окрашивание Flow Map
* отображение Transaction Scorecards (хрень с графиком нормальных/медленных транзакций, графиком Событий и Снапшотов)
* сравнивания метрик в Браузере Метрик и на графиках метрик (под Flow Map)
* оценивать здоровье приложения через Health Rules

### Как работают Baselines? 

Baselines рассчитываются по данным с каждого прошедшего часа. Базовую линию можно рассчитывать для каждой метрики. У базовых линий есть две основных переменных:
* временной период, на основе которого должна рассчитываться базовая линия
* сезонность базовой линии

Базовые линии могут оценивать тренды за определенный промежуток времени (пример - некоторое приложение нагружено больше по выходным, чем в будние дни, для этого используется недельная базовая линия с учетом информации за последние три месяца)

Также, базовым линиям можно задать фиксированный период времени. 

По-умолчанию, базовые линии не генерируются, если количество запросов не превышает 20 в минуту, но это можно настроить. 

## Threshold 

Threshold - граница поведения допустимой или нормальной бизнес-транзакции. Их можно настроить глобально, либо применимо к конкретным транзакциям. 

Доступные единицы измерений: 
* проценты 
* миллисекунды
* стандартные отклонения

В случае с процентами и стандартными отклонениями показатели сравниваются с их средним значением за последнее N количество минут/часов/дней, в зависимости от важности транзакции, за которой закреплен Threshold.

Когда начинается транзакция, соответствующий тред мониторится на предмет остановки. Каждые пять секунд активные транзакции оцениваются для того, чтобы определить их состояние и сравнить их показатели с Threshold.

Если (при включенном отслеживании Stalled транзакций) состояния Stall не наступило, то время выполнения транзакции сравнивается с границами медленных и очень медленных транзакций, а затем транзакции присваивается соответствующая иконка.

Thresholds не влияют на ошибочные транзакции, для них используются коды HTTP (с 400 по 505) либо другие исключения.

Границы могут быть:
* статические (миллисекунды, период времени не важен)
* динамические (проценты и отклонения, период времени важен и указывается явно)

## Бизнес-транзакции

В AppDynamics, бизнес-транзакция отражает путь пользовательского запроса, направленного на использование определенной функции наблюдаемого приложения; то есть, по факту, явлется представлением конкретного бизнес-процесса.

## Service Endpoint 

Аналог бизнес-транзакций для мониторинга производительности отдельных сервисов, но без какого-либо контекста: пофиг, в какой очередности или в каких условиях сервис заработал и выдал свои метрики, мы их считываем начистую.

# Требования для компонентов AppDynamics

## Enterprise Console

Рекомендуется располагать консоль на отдельном хосте, хотя ее существование возможно параллельно с контроллером и Events Service.

Интерфейс консоли - HTML5-приложение, совместимо с любыми современными браузерами. Могут быть проблемы с ад-блоком. 

### Процессор 

Два ядра норм даже для нескольких платформ.

### ОЗУ

Требуется один дополнительный гигабайт памяти сверх имеющейся для того, чтобы Java и MySQL процессы работали адекватно.

### Место на диске

Нужно 10 + 1 гигабайт для размещения консоли и проведения разных операций, например, установки контроллера. 

### Сеть

Нужно настроить SSH или SFTP. 

(для Linux-хостов необходимо также установить cURL)

### Linux-библиотеки

* libaio
* numactl
* glibc
* tzdata
* libncurses5
* ncurses-libs-5.x

## Хост с контроллером

Контроллер - центральное хранилище и центр аналитики, где хранятся данные о производительности и их базовые линии, а также проводится аналитика на основе этих данных. 

Контроллер может развернут как в On-premise, так и в SaaS. 

Доступ к данным контроллера осуществляется либо через графический интерфейс, либо с помощью REST API. 

### Общие требования

* контроллер желательно держать на отдельном хосте, а для продакшена **нужно**
* PowerPC не поддерживается, только amd64 и x86-64
* не опускать количество свободного места до <200 мегабайт
* задержка диска не должна превышать 3 миллисекунды при достаточной нагрузке

### On-premise

В зависимости от количества nodes и частоты поступления метрик различается пять профилей контроллера:

| Профиль | Частота метрик | Максимальное кол-во агентов | OS  | Вычислительная мощность | Хранилище |
|---------|----------------|-----------------------------|-----|-------------------------|-----------|
| Demo    | 10000          | 5                           | L/W | 2 ядра, 8ГБ ОЗУ         | 50ГБ      |
| Small   | 50000          | 50                          | L/W | 4 ядра, 16ГБ ОЗУ        | 400ГБ     |
| Medium  | 1000000        | 1500                        | L/W | Голое железо, 8 ядер, 128ГБ ОЗУ | 5ТБ SAS SSD |
|         |                |                             |     | VM, 16 виртуальных ЦП, 128ГБ ОЗУ | 5ТБ SSD SAN (10 Gb/s FCoE) |
| Large   | 5000000        | 10000                       | L   | Голое железо, 28 ядер, 512ГБ ОЗУ | 2 x 800ГБ NVMe для MySQL RAID 1, 20TB SAS SSDs для основных данных RAID 5 |
| Extra Large | - | - | - | - | - |

## EUM 

Для 10 тысяч одновременных запросов к странице или 10 тысяч пользователей предлагаются следующие спецификации:

* 50 дополнительных гигабайт места
* 64-битный Windows или Linux
* 4 ядра
* пропускная способность - 10 Мбит/с
* минимум 8 гигабайт ОЗУ, чем больше запросов, страниц и сессий - тем нужно больше памяти
* NTP (синхронизация времени)

EUM сервер по-умолчанию допускает тысячу снапшотов в минуту и хранит их 15 дней. Чем больше снапшотов, тем больше нужно места на диске. Например, если их 500 в минуту, нужно больше 40 гигабайт, а если 2000 - то уже 128 гигабайт.

При использовании на Linux, необходимо настроить user limit (дескриптор открытых файлов - 65535, процесс - 8192).

## Events Service

Все примерно то же самое, что и для EUM, но можно дополнить:

* как минимум 1ТБ SSD (или на крайний случай хороший HDD)
* для heap space нужно от 7 до 31 гигабайта ОЗУ
* JVM 1.8
* порт 9080 должен быть открыт для того, чтобы можно было получить доступ к ES через консоль удаленно

# Mobile RUM

Pro и Lite (и SaaS, и On-premise). В PRO 5 тысяч уникальных установок приложений с встроенным Mobile RUM, в Lite можно смотреть аналитику крашей с 2 миллионов агентов.

# Browser RUM

Pro и Lite. 
